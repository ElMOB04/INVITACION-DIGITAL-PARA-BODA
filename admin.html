<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Jorge & Kandy</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background: #F9F7F2;
        }

        h1,
        h2,
        h3 {
            font-family: 'Cinzel', serif;
        }

        .gold-btn {
            background: #C5A059;
            color: white;
            transition: all 0.3s;
        }

        .gold-btn:hover {
            background: #b08d4a;
            transform: translateY(-2px);
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl text-[#A64B2A] font-bold">Panel de Invitados</h1>
            <button onclick="refreshList()" class="text-sm text-gray-500 hover:text-black">Actualizar</button>
        </div>

        <!-- STATS -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="stats-container">
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <p class="text-xs uppercase text-gray-400">Invitados</p>
                <p class="text-2xl font-bold text-gray-700" id="stat-total">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <p class="text-xs uppercase text-green-600">Asistirán</p>
                <p class="text-2xl font-bold text-green-600" id="stat-attending">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <p class="text-xs uppercase text-red-400">Rechazaron</p>
                <p class="text-2xl font-bold text-red-400" id="stat-declined">0</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                <p class="text-xs uppercase text-yellow-500">Pendientes</p>
                <p class="text-2xl font-bold text-yellow-500" id="stat-pending">0</p>
            </div>
        </div>

        <!-- CREATE -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl mb-4 text-[#A64B2A]">Nueva Invitación</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="guest-names" placeholder="Nombres de invitados (separados por coma)"
                    class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#C5A059]">
                <button onclick="createInvitation()" class="gold-btn px-6 py-3 rounded-lg font-bold">Generar
                    Link</button>
            </div>
            <p class="text-xs text-gray-400 mt-2">Ejemplo: Juan Pérez, María Gómez, Pedrito</p>

            <!-- Created Link Result -->
            <div id="result-area" class="mt-4 hidden p-4 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-800 font-bold mb-2">¡Invitación Creada!</p>
                <div class="flex gap-2">
                    <input type="text" id="generated-link" readonly
                        class="flex-1 p-2 bg-white border border-gray-200 text-sm font-mono rounded">
                    <button onclick="copyLink()"
                        class="bg-white border border-gray-300 px-3 rounded text-sm hover:bg-gray-50">Copiar</button>
                    <a id="whatsapp-link" href="#" target="_blank"
                        class="bg-green-500 text-white px-3 py-2 rounded text-sm hover:bg-green-600">WhatsApp</a>
                </div>
            </div>
        </div>

        <!-- LIST -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                        <tr>
                            <th class="p-4">Invitados</th>
                            <th class="p-4">Estado</th>
                            <th class="p-4">Asistencia</th>
                            <th class="p-4">Mensaje</th>
                            <th class="p-4 text-right">Link</th>
                        </tr>
                    </thead>
                    <tbody id="invitations-list" class="divide-y divide-gray-100 text-sm">
                        <!-- Rows injected by JS -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const API_URL = 'backend/api.php';

        async function createInvitation() {
            const namesInput = document.getElementById('guest-names');
            const names = namesInput.value.split(',').map(n => n.trim()).filter(n => n);

            if (names.length === 0) return alert("Escribe al menos un nombre");

            try {
                const res = await fetch(`${API_URL}?action=create`, {
                    method: 'POST',
                    body: JSON.stringify({ guests: names })
                });
                const data = await res.json();

                if (data.success) {
                    const link = `${window.location.origin}/invitacion/index.html?id=${data.uuid}`;
                    document.getElementById('result-area').classList.remove('hidden');
                    document.getElementById('generated-link').value = link;

                    // WhatsApp Link
                    const text = `Hola! Nos encantaría que nos acompañen en nuestra boda. Aquí tienes tu invitación personalizada: ${link}`;
                    document.getElementById('whatsapp-link').href = `https://wa.me/?text=${encodeURIComponent(text)}`;

                    namesInput.value = '';
                    refreshList();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexión');
            }
        }

        function copyLink() {
            const copyText = document.getElementById("generated-link");
            copyText.select();
            document.execCommand("copy");
            alert("Link copiado!");
        }

        async function refreshList() {
            try {
                const res = await fetch(`${API_URL}?action=list`);
                const data = await res.json();

                // Update Stats
                if (data.stats) {
                    document.getElementById('stat-total').innerText = data.stats.total_invited || 0;
                    document.getElementById('stat-attending').innerText = data.stats.total_attending || 0;
                    document.getElementById('stat-declined').innerText = data.stats.total_declined_invitations || 0;
                    document.getElementById('stat-pending').innerText = data.stats.total_pending_invitations || 0;
                }

                // Render List
                const tbody = document.getElementById('invitations-list');
                tbody.innerHTML = '';

                data.invitations.forEach(inv => {
                    let statusColor = 'bg-yellow-100 text-yellow-800';
                    let statusText = 'Pendiente';

                    if (inv.status === 'confirmed') {
                        statusColor = 'bg-green-100 text-green-800';
                        statusText = 'Confirmado';
                    } else if (inv.status === 'declined') {
                        statusColor = 'bg-red-100 text-red-800';
                        statusText = 'Declinado';
                    }

                    const link = `${window.location.origin}/invitacion/index.html?id=${inv.uuid}`;

                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="p-4 font-medium text-gray-800">${inv.guest_names}</td>
                            <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${statusColor}">${statusText}</span></td>
                            <td class="p-4 text-gray-500">${inv.attending_count || 0} / ${inv.total_guests}</td>
                            <td class="p-4 text-gray-500 italic max-w-xs truncate">${inv.message || '-'}</td>
                            <td class="p-4 text-right">
                                <a href="${link}" target="_blank" class="text-[#C5A059] hover:underline text-xs">Ver Inv</a>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (e) {
                console.error(e);
            }
        }

        // Init
        refreshList();

    </script>
</body>

</html>